<Window x:Class="FCZ.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:FCZ.App"
        xmlns:controls="clr-namespace:FCZ.App.Controls"
        xmlns:converters="clr-namespace:FCZ.App.Converters"
        xmlns:vm="clr-namespace:FCZ.App.ViewModels"
        mc:Ignorable="d"
        Title="FCZ Screen Automation Debugger" 
        Height="700" Width="1200"
        MinWidth="1000" MinHeight="600">
    <Window.Resources>
        <local:BoolToColorConverter x:Key="BoolToColorConverter"/>
        <local:BoolToYesNoConverter x:Key="BoolToYesNoConverter"/>
        <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:SelectionModeToTextConverter x:Key="SelectionModeToTextConverter"/>
        <converters:SizeToStringConverter x:Key="SizeToStringConverter"/>
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
        <converters:IndexPlusOneConverter x:Key="IndexPlusOneConverter"/>
        <converters:StepTypeToIconConverter x:Key="StepTypeToIconConverter"/>
        <converters:StepTypeToColorConverter x:Key="StepTypeToColorConverter"/>
        <converters:ValidationErrorColorConverter x:Key="ValidationErrorColorConverter"/>
        <converters:FileSizeConverter x:Key="FileSizeConverter"/>
        <converters:TemplateCountConverter x:Key="TemplateCountConverter"/>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter"/>
        <converters:UnsavedChangesColorConverter x:Key="UnsavedChangesColorConverter"/>
        <converters:UnsavedChangesTextConverter x:Key="UnsavedChangesTextConverter"/>
        <converters:ReadyStatusColorConverter x:Key="ReadyStatusColorConverter"/>
        <converters:SelectionModeVisibilityConverter x:Key="SelectionModeVisibilityConverter"/>
    </Window.Resources>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*"/>
            <ColumnDefinition Width="3*"/>
        </Grid.ColumnDefinitions>

        <!-- Left: Preview -->
        <Border Grid.Column="0" BorderBrush="Gray" BorderThickness="1" Margin="5">
            <Grid>
                <Image Source="{Binding CurrentFrame}" Stretch="Uniform"/>
                <TextBlock Text="No capture" HorizontalAlignment="Center" VerticalAlignment="Center" 
                          Foreground="Gray" FontSize="16" 
                          Visibility="{Binding CurrentFrame, Converter={StaticResource NullToVisibilityConverter}}"/>
            </Grid>
        </Border>

        <!-- Right: TabControl -->
        <TabControl Grid.Column="1" Margin="5">
            <!-- User Tab -->
            <TabItem Header="User">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Status Section -->
                    <GroupBox Grid.Row="0" Header="Status" Margin="0,0,0,10">
                        <StackPanel>
                            <TextBlock Text="{Binding StatusMessage}" FontWeight="Bold" Margin="5"/>
                            <StackPanel Orientation="Horizontal" Margin="5,2">
                                <TextBlock Text="Process: " FontWeight="SemiBold"/>
                                <TextBlock>
                                    <TextBlock.Text>
                                        <Binding Path="ProcessStatus"/>
                                    </TextBlock.Text>
                                    <TextBlock.Foreground>
                                        <Binding Path="IsProcessFound" Converter="{StaticResource BoolToColorConverter}"/>
                                    </TextBlock.Foreground>
                                </TextBlock>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="5,2">
                                <TextBlock Text="Capture: " FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding CaptureStatus}"/>
                                <TextBlock Text=" (" Margin="5,0,0,0"/>
                                <TextBlock Text="{Binding Fps}"/>
                                <TextBlock Text=" FPS)" Margin="0,0,5,0"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="5,2">
                                <TextBlock Text="Running: " FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding IsRunning, Converter={StaticResource BoolToYesNoConverter}}"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>
                    
                    <Label Grid.Row="1" Content="Scenario:"/>
                    <ComboBox Grid.Row="2" ItemsSource="{Binding Scenarios}" SelectedItem="{Binding SelectedScenario}" 
                              DisplayMemberPath="Name" Margin="0,0,0,10"/>

                    <!-- Quick Scenario Buttons -->
                    <GroupBox Grid.Row="3" Header="Quick Scenario Buttons" Margin="0,0,0,10">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <UniformGrid Grid.Row="0" Columns="5" Rows="2" Margin="0,0,0,5">
                                <Button Content="{Binding ScenarioButtons[0].DisplayName}" 
                                       Command="{Binding RunScenarioFromButtonCommand}"
                                       CommandParameter="0"
                                       IsEnabled="{Binding ScenarioButtons[0].IsAssigned}"
                                       Margin="2" Padding="5,2"/>
                                <Button Content="{Binding ScenarioButtons[1].DisplayName}" 
                                       Command="{Binding RunScenarioFromButtonCommand}"
                                       CommandParameter="1"
                                       IsEnabled="{Binding ScenarioButtons[1].IsAssigned}"
                                       Margin="2" Padding="5,2"/>
                                <Button Content="{Binding ScenarioButtons[2].DisplayName}" 
                                       Command="{Binding RunScenarioFromButtonCommand}"
                                       CommandParameter="2"
                                       IsEnabled="{Binding ScenarioButtons[2].IsAssigned}"
                                       Margin="2" Padding="5,2"/>
                                <Button Content="{Binding ScenarioButtons[3].DisplayName}" 
                                       Command="{Binding RunScenarioFromButtonCommand}"
                                       CommandParameter="3"
                                       IsEnabled="{Binding ScenarioButtons[3].IsAssigned}"
                                       Margin="2" Padding="5,2"/>
                                <Button Content="{Binding ScenarioButtons[4].DisplayName}" 
                                       Command="{Binding RunScenarioFromButtonCommand}"
                                       CommandParameter="4"
                                       IsEnabled="{Binding ScenarioButtons[4].IsAssigned}"
                                       Margin="2" Padding="5,2"/>
                                <Button Content="{Binding ScenarioButtons[5].DisplayName}" 
                                       Command="{Binding RunScenarioFromButtonCommand}"
                                       CommandParameter="5"
                                       IsEnabled="{Binding ScenarioButtons[5].IsAssigned}"
                                       Margin="2" Padding="5,2"/>
                                <Button Content="{Binding ScenarioButtons[6].DisplayName}" 
                                       Command="{Binding RunScenarioFromButtonCommand}"
                                       CommandParameter="6"
                                       IsEnabled="{Binding ScenarioButtons[6].IsAssigned}"
                                       Margin="2" Padding="5,2"/>
                                <Button Content="{Binding ScenarioButtons[7].DisplayName}" 
                                       Command="{Binding RunScenarioFromButtonCommand}"
                                       CommandParameter="7"
                                       IsEnabled="{Binding ScenarioButtons[7].IsAssigned}"
                                       Margin="2" Padding="5,2"/>
                                <Button Content="{Binding ScenarioButtons[8].DisplayName}" 
                                       Command="{Binding RunScenarioFromButtonCommand}"
                                       CommandParameter="8"
                                       IsEnabled="{Binding ScenarioButtons[8].IsAssigned}"
                                       Margin="2" Padding="5,2"/>
                                <Button Content="{Binding ScenarioButtons[9].DisplayName}" 
                                       Command="{Binding RunScenarioFromButtonCommand}"
                                       CommandParameter="9"
                                       IsEnabled="{Binding ScenarioButtons[9].IsAssigned}"
                                       Margin="2" Padding="5,2"/>
                            </UniformGrid>
                            <Button Grid.Row="1" Content="âš™ï¸ Manage Buttons" 
                                   Command="{Binding ManageScenarioButtonsCommand}"
                                   HorizontalAlignment="Center"
                                   Padding="10,5"/>
                        </Grid>
                    </GroupBox>

                    <StackPanel Grid.Row="4" Orientation="Horizontal" Margin="0,0,0,10">
                        <Button Content="Má»Ÿ Game" Command="{Binding LaunchGameCommand}" 
                                Margin="0,0,5,0"/>
                        <Button Content="Run Scenario" Command="{Binding RunScenarioCommand}" 
                                IsEnabled="{Binding IsProcessFound}" Margin="0,0,5,0"/>
                        <Button Content="Stop" Command="{Binding StopScenarioCommand}" 
                                IsEnabled="{Binding IsRunning}"/>
                    </StackPanel>

                    <CheckBox Grid.Row="5" Content="áº¨n cá»­a sá»• Game (Background Mode)" IsChecked="{Binding IsBackgroundMode}" 
                              Command="{Binding ToggleBackgroundModeCommand}" Margin="0,0,0,10"/>

                    <!-- Window Control Section -->
                    <GroupBox Grid.Row="6" Header="Window Control" Margin="0,0,0,10">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="5,5">
                                <Label Content="Size:" VerticalAlignment="Center" Width="60"/>
                                <ComboBox ItemsSource="{Binding WindowSizePresets}" 
                                         SelectedItem="{Binding SelectedWindowSize}"
                                         DisplayMemberPath="Name" 
                                         Width="200" Margin="0,0,5,0"/>
                                <Button Content="Apply Size" Command="{Binding ApplyWindowSizeCommand}" 
                                       IsEnabled="{Binding IsProcessFound}" Margin="0,0,5,0"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="5,5">
                                <Button Content="Move to (0,0)" Command="{Binding MoveWindowToOriginCommand}" 
                                       IsEnabled="{Binding IsProcessFound}" Margin="0,0,5,0"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>

                    <!-- Log Section -->
                    <GroupBox Grid.Row="8" Header="Activity Log" Margin="0,0,0,10">
                        <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="200">
                            <TextBox Text="{Binding LogText}" IsReadOnly="True" 
                                    TextWrapping="Wrap" 
                                    Background="Black" Foreground="Lime" 
                                    BorderThickness="0" Padding="5"/>
                        </ScrollViewer>
                    </GroupBox>
                </Grid>
            </TabItem>

            <!-- Dev Tab -->
            <TabItem Header="Dev">
                <Grid Margin="10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="0.4*" MinWidth="300"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="0.6*" MinWidth="400"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="0*" x:Name="HelpColumn"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left Column: Preview Panel -->
                    <Grid Grid.Column="0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Preview with Selection -->
                        <Border Grid.Row="0" BorderBrush="Gray" BorderThickness="1" Margin="0,0,0,5" Background="Black">
                            <Grid>
                                <controls:PreviewSelectorControl x:Name="PreviewSelector"
                                CurrentFrame="{Binding CurrentFrame}"
                                SelectionMode="{Binding ScenarioEditorViewModel.SelectionMode, Mode=TwoWay}"
                                SelectedRegion="{Binding ScenarioEditorViewModel.PreviewRegion, Mode=TwoWay}"
                                SelectedPoint="{Binding ScenarioEditorViewModel.PreviewPoint, Mode=TwoWay}"
                                ShowCoordinates="True"/>
                                <!-- FPS and Resolution Overlay -->
                                <StackPanel HorizontalAlignment="Right" VerticalAlignment="Top" 
                                           Background="#80000000" Margin="5">
                                    <TextBlock Text="{Binding Fps, StringFormat='FPS: {0}'}" 
                                              Foreground="Lime" FontSize="11" Margin="5"/>
                                    <TextBlock Foreground="Lime" FontSize="11" Margin="5,2,5,5">
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="{}{0}Ã—{1}">
                                                <Binding Path="CurrentFrame.PixelWidth"/>
                                                <Binding Path="CurrentFrame.PixelHeight"/>
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>
                                <!-- Help Overlay -->
                                <Border HorizontalAlignment="Left" VerticalAlignment="Top" 
                                       Background="#E0FFFFFF" 
                                       Padding="10" 
                                       Margin="5"
                                       CornerRadius="5"
                                       Visibility="{Binding CurrentFrame, Converter={StaticResource NullToVisibilityConverter}}">
                                    <StackPanel>
                                        <TextBlock Text="ðŸ“‹ Preview Controls" 
                                                  FontWeight="Bold" 
                                                  Margin="0,0,0,5"/>
                                        <TextBlock Text="â€¢ Ctrl+R: Select Region" 
                                                  FontSize="10" 
                                                  Margin="0,2"/>
                                        <TextBlock Text="â€¢ Ctrl+P: Select Point" 
                                                  FontSize="10" 
                                                  Margin="0,2"/>
                                        <TextBlock Text="â€¢ Ctrl+Wheel: Zoom" 
                                                  FontSize="10" 
                                                  Margin="0,2"/>
                                        <TextBlock Text="â€¢ Right-drag: Pan (when zoomed)" 
                                                  FontSize="10" 
                                                  Margin="0,2"/>
                                        <TextBlock Text="â€¢ Esc: Clear Selection" 
                                                  FontSize="10" 
                                                  Margin="0,2"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </Border>

                        <!-- Selection Mode Indicator -->
                        <Border Grid.Row="1" 
                               Background="#E0E0FF"
                               Padding="10,5"
                                  Margin="0,0,0,5"
                               CornerRadius="3">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding ScenarioEditorViewModel.SelectionMode, Converter={StaticResource SelectionModeToTextConverter}}"
                                  FontWeight="SemiBold"
                                          Foreground="DarkBlue"
                                          VerticalAlignment="Center"/>
                                <TextBlock Text=" (Press Esc to cancel)" 
                                          FontSize="10"
                                          Foreground="Gray"
                                          Margin="10,0,0,0"
                                          VerticalAlignment="Center"
                                          Visibility="{Binding ScenarioEditorViewModel.SelectionMode, Converter={StaticResource SelectionModeVisibilityConverter}}"/>
                            </StackPanel>
                        </Border>

                        <!-- Quick Actions Toolbar -->
                        <WrapPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center">
                            <Button Content="ðŸ“ Select Region" 
                                   Command="{Binding ScenarioEditorViewModel.SelectRegionModeCommand}"
                                   Margin="2" Padding="8,4"
                                   ToolTip="Select a region on the preview (Ctrl+R)"/>
                            <Button Content="ðŸ“ Select Point" 
                                   Command="{Binding ScenarioEditorViewModel.SelectPointModeCommand}"
                                   Margin="2" Padding="8,4"
                                   ToolTip="Select a point on the preview (Ctrl+P)"/>
                            <Button Content="ðŸ“· Capture Template" 
                                   Command="{Binding ScenarioEditorViewModel.CaptureTemplateCommand}"
                                   Margin="2" Padding="8,4"
                                   ToolTip="Capture selected region as template"/>
                            <Separator Margin="5,0" Width="1" Height="20" VerticalAlignment="Center"/>
                            <Button Content="ðŸ”+" 
                                   Click="ZoomIn_Click"
                                   Margin="2" Padding="8,4"
                                   ToolTip="Zoom in (Ctrl+Wheel)"/>
                            <Button Content="ðŸ”-" 
                                   Click="ZoomOut_Click"
                                   Margin="2" Padding="8,4"
                                   ToolTip="Zoom out (Ctrl+Wheel)"/>
                            <Button Content="ðŸ” Reset" 
                                   Click="ZoomReset_Click"
                                   Margin="2" Padding="8,4"
                                   ToolTip="Reset zoom"/>
                            <Separator Margin="5,0" Width="1" Height="20" VerticalAlignment="Center"/>
                            <Button Content="âœ– Clear" 
                                   Command="{Binding ScenarioEditorViewModel.ClearSelectionCommand}"
                                   Margin="2" Padding="8,4"
                                   ToolTip="Clear current selection (Esc)"/>
                        </WrapPanel>
                    </Grid>

                    <!-- GridSplitter for resizing panels -->
                    <GridSplitter Grid.Column="1" 
                                 Width="5" 
                                 HorizontalAlignment="Center" 
                                 VerticalAlignment="Stretch"
                                 ResizeDirection="Columns"
                                 Background="Gray"
                                 ShowsPreview="False"/>

                    <!-- GridSplitter for Help Panel -->
                    <GridSplitter Grid.Column="3" 
                                 Width="5" 
                                 HorizontalAlignment="Center" 
                                 VerticalAlignment="Stretch"
                                 ResizeDirection="Columns"
                                 Background="LightGray"
                                 ShowsPreview="False"
                                 Visibility="Collapsed"
                                 x:Name="HelpSplitter"/>

                    <!-- Help Panel -->
                    <ScrollViewer Grid.Column="4" 
                                 VerticalScrollBarVisibility="Auto"
                                 HorizontalScrollBarVisibility="Disabled"
                                 Visibility="Collapsed"
                                 x:Name="HelpPanelScroll">
                        <controls:HelpPanel/>
                    </ScrollViewer>

                    <!-- Right Column: Editor Panel -->
                    <Grid Grid.Column="2">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Help Toggle Button and Quick Start -->
                        <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,5">
                            <Button Content="ðŸš€ Quick Start" 
                                   Margin="0,0,5,0"
                                   Padding="5,2"
                                   Click="ShowQuickStart_Click"
                                   ToolTip="Show Quick Start guide for first-time users"/>
                            <Button Content="â“ Help" 
                                   Padding="5,2"
                                   Click="ToggleHelp_Click"
                                   ToolTip="Show/Hide help panel with guides and tips.&#x0a;Contains: Quick Start guide, Step Types reference, Template tips, and Troubleshooting."/>
                        </StackPanel>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Scenario Info Form -->
                        <GroupBox Grid.Row="1" Header="Scenario Information" Margin="0,0,0,10">
                            <StackPanel>
                                <!-- Status Badge -->
                                <StackPanel Orientation="Horizontal" Margin="5,5,5,0">
                                    <Border Background="{Binding ScenarioEditorViewModel.HasUnsavedChanges, Converter={StaticResource UnsavedChangesColorConverter}}" 
                                           Padding="5,2" 
                                           CornerRadius="3"
                                           Margin="0,0,5,0">
                                        <TextBlock FontSize="10" FontWeight="SemiBold" Foreground="White">
                                            <TextBlock.Text>
                                                <MultiBinding StringFormat="{}{0} - {1}">
                                                    <Binding Path="ScenarioEditorViewModel.CurrentScenario.Name"/>
                                                    <Binding Path="ScenarioEditorViewModel.HasUnsavedChanges">
                                                        <Binding.Converter>
                                                            <converters:UnsavedChangesTextConverter/>
                                                        </Binding.Converter>
                                                    </Binding>
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                    </Border>
                                </StackPanel>
                            <Grid Margin="5">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Label Grid.Row="0" Grid.Column="0" Content="Id:" VerticalAlignment="Center" Margin="0,2"/>
                                <TextBox Grid.Row="0" Grid.Column="1" 
                                        Text="{Binding ScenarioEditorViewModel.CurrentScenario.Id}" 
                                        IsReadOnly="True" Margin="5,2"
                                        ToolTip="Unique identifier for this scenario. Auto-generated from name and cannot be changed."/>

                                <Label Grid.Row="1" Grid.Column="0" Content="Name:" VerticalAlignment="Center" Margin="0,2"/>
                                <TextBox Grid.Row="1" Grid.Column="1" 
                                        Text="{Binding ScenarioEditorViewModel.CurrentScenario.Name, UpdateSourceTrigger=PropertyChanged}" 
                                        Margin="5,2"
                                        ToolTip="Scenario name (required). This will be displayed in the scenarios list.&#x0a;Tip: Use descriptive names like 'Login Flow' or 'Daily Quest'."/>

                                <Label Grid.Row="2" Grid.Column="0" Content="Description:" VerticalAlignment="Top" Margin="0,2"/>
                                <TextBox Grid.Row="2" Grid.Column="1" 
                                        Text="{Binding ScenarioEditorViewModel.CurrentScenario.Description, UpdateSourceTrigger=PropertyChanged}" 
                                        TextWrapping="Wrap" AcceptsReturn="True" 
                                        Height="50" Margin="5,2"
                                        ToolTip="Optional description of what this scenario does.&#x0a;Example: 'Automates the daily login process and collects rewards'"/>

                                <Label Grid.Row="3" Grid.Column="0" Content="Window Size:" VerticalAlignment="Center" Margin="0,2"/>
                                <ComboBox Grid.Row="3" Grid.Column="1" 
                                         ItemsSource="{Binding ScenarioEditorViewModel.WindowSizePresets}"
                                         SelectedItem="{Binding ScenarioEditorViewModel.SelectedWindowSize}"
                                         Margin="5,2"
                                         ToolTip="Target window size for the game. Must match the actual game window size.&#x0a;Tip: Check your game settings to see the current resolution.&#x0a;Common: 1280x720, 1600x900, 1920x1080">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource SizeToStringConverter}}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>

                                <Label Grid.Row="4" Grid.Column="0" Content="Target Process:" VerticalAlignment="Center" Margin="0,2"/>
                                <TextBox Grid.Row="4" Grid.Column="1" 
                                        Text="{Binding ScenarioEditorViewModel.CurrentScenario.TargetProcess, UpdateSourceTrigger=PropertyChanged}" 
                                        Margin="5,2"
                                        ToolTip="Process name to attach to (without .exe).&#x0a;Default: 'fczf' for FC ONLINE.&#x0a;The app will automatically find and attach to this process."/>
                            </Grid>
                                <TextBlock Text="ðŸ’¡ Tip: Fill in scenario name and description first. Window size should match your game resolution." 
                                          FontSize="11" 
                                          Foreground="Gray" 
                                          TextWrapping="Wrap"
                                          Margin="5,5,5,0"
                                          FontStyle="Italic"/>
                                <TextBlock Text="ðŸ“Œ Status: " 
                                          FontSize="10" 
                                          FontWeight="SemiBold"
                                          Foreground="DarkGray"
                                          Margin="5,5,0,0">
                                    <Run Text="Ready" 
                                        Foreground="{Binding ScenarioEditorViewModel.HasUnsavedChanges, Converter={StaticResource ReadyStatusColorConverter}}"/>
                                </TextBlock>
                            </StackPanel>
                        </GroupBox>

                        <!-- Steps Management -->
                        <GroupBox Grid.Row="2" Header="Steps" Margin="0,0,0,10">
                            <Grid Margin="5">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*" MinHeight="150" MaxHeight="400"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- Steps Toolbar -->
                                <WrapPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,5">
                                    <ComboBox ItemsSource="{Binding ScenarioEditorViewModel.AvailableStepTypes}"
                                             SelectedItem="{Binding ScenarioEditorViewModel.SelectedStepType}"
                                             Width="150" Margin="0,0,5,0"
                                             ToolTip="Select the type of step to add.&#x0a;Common types:&#x0a;- waitForImageThenClick: Wait for image then click&#x0a;- clickPoint: Click at specific coordinates&#x0a;- typeText: Type text into a field"/>
                                    <Button Content="Add Step" 
                                           Command="{Binding ScenarioEditorViewModel.AddStepCommand}"
                                           Margin="2" Padding="5,2"
                                           ToolTip="Add a new step to the scenario.&#x0a;The step type is selected from the dropdown above.&#x0a;Tip: Steps execute in order from top to bottom."/>
                                    <Button Content="Remove" 
                                           Command="{Binding ScenarioEditorViewModel.RemoveStepCommand}"
                                           Margin="2" Padding="5,2"
                                           ToolTip="Remove the selected step.&#x0a;Shortcut: Delete key&#x0a;Warning: This action cannot be undone (use Undo if needed)."/>
                                    <Button Content="â†‘" 
                                           Command="{Binding ScenarioEditorViewModel.MoveStepUpCommand}"
                                           Margin="2" Padding="5,2" Width="30"
                                           ToolTip="Move selected step up in the execution order.&#x0a;Steps execute from top to bottom."/>
                                    <Button Content="â†“" 
                                           Command="{Binding ScenarioEditorViewModel.MoveStepDownCommand}"
                                           Margin="2" Padding="5,2" Width="30"
                                           ToolTip="Move selected step down in the execution order."/>
                                    <Button Content="Duplicate" 
                                           Command="{Binding ScenarioEditorViewModel.DuplicateStepCommand}"
                                           Margin="2" Padding="5,2"
                                           ToolTip="Create a copy of the selected step.&#x0a;Shortcut: Ctrl+D&#x0a;Useful for creating similar steps with minor changes."/>
                                </WrapPanel>

                                <!-- Search Filter -->
                                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,5">
                                    <Label Content="Search:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBox Text="{Binding ScenarioEditorViewModel.StepSearchFilter, UpdateSourceTrigger=PropertyChanged}"
                                            Width="200" Margin="0,0,5,0"
                                            ToolTip="Filter steps by ID or Type.&#x0a;Example: Type 'click' to show all click-related steps.&#x0a;Leave empty to show all steps."/>
                                    <TextBlock Text="{Binding ScenarioEditorViewModel.CurrentScenario.Steps.Count, StringFormat='Total: {0}'}"
                                              VerticalAlignment="Center"
                                              Foreground="Gray"
                                              Margin="5,0,0,0"
                                              ToolTip="Total number of steps in this scenario."/>
                                </StackPanel>

                                <!-- Info Text -->
                                <Border Grid.Row="2" 
                                       Background="#F0F8FF"
                                       BorderBrush="#B0C4DE"
                                       BorderThickness="1"
                                       Padding="8,5"
                                       CornerRadius="3"
                                       Margin="0,5,0,5">
                                    <TextBlock Text="ðŸ’¡ Select a step type, click 'Add Step', then configure it in the Step Editor below.&#x0a;ðŸ’¡ Use search box to filter steps. Click on a step to edit it." 
                                              FontSize="11" 
                                              Foreground="DarkSlateGray" 
                                              TextWrapping="Wrap"
                                              FontStyle="Italic"/>
                                </Border>

                                <!-- Steps ListView -->
                                <ListView Grid.Row="3" 
                                         ItemsSource="{Binding ScenarioEditorViewModel.FilteredSteps}"
                                         SelectedItem="{Binding ScenarioEditorViewModel.SelectedStep}">
                                    <ListView.View>
                                        <GridView>
                                            <GridViewColumn Header="#" Width="40">
                                                <GridViewColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Converter={StaticResource IndexPlusOneConverter}}"
                                                                  HorizontalAlignment="Center"/>
                                                    </DataTemplate>
                                                </GridViewColumn.CellTemplate>
                                            </GridViewColumn>
                                            <GridViewColumn Header="Type" Width="180">
                                                <GridViewColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding Type, Converter={StaticResource StepTypeToIconConverter}}"
                                                                      FontSize="14"
                                                                      Margin="0,0,5,0"/>
                                                            <TextBlock Text="{Binding Type}">
                                                                <TextBlock.Foreground>
                                                                    <Binding Path="Type" Converter="{StaticResource StepTypeToColorConverter}"/>
                                                                </TextBlock.Foreground>
                                                            </TextBlock>
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </GridViewColumn.CellTemplate>
                                            </GridViewColumn>
                                            <GridViewColumn Header="Id" Width="120" DisplayMemberBinding="{Binding Id}"/>
                                        </GridView>
                                    </ListView.View>
                                </ListView>

                                <!-- Steps Summary -->
                                <TextBlock Grid.Row="4" 
                                          HorizontalAlignment="Right"
                                          Foreground="Gray"
                                          Margin="0,5,0,0"
                                          FontSize="11">
                                    <TextBlock.Text>
                                        <Binding Path="ScenarioEditorViewModel.CurrentScenario.Steps.Count">
                                            <Binding.StringFormat>
                                                {0} step(s) total
                                            </Binding.StringFormat>
                                        </Binding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </Grid>
                        </GroupBox>

                        <!-- Step Editor -->
                        <GroupBox Grid.Row="3" Header="Step Editor" Margin="0,0,0,10">
                            <StackPanel>
                            <Grid Margin="5">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                    <ScrollViewer Grid.Row="0" 
                                                VerticalScrollBarVisibility="Auto"
                                                HorizontalScrollBarVisibility="Disabled"
                                                MaxHeight="500">
                                        <controls:StepEditorControl 
                                                           Content="{Binding ScenarioEditorViewModel.SelectedStep}"/>
                                    </ScrollViewer>

                                <!-- Use Selection Buttons -->
                                <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5,0,0">
                                    <Button Content="Use Selected Region" 
                                           Command="{Binding ScenarioEditorViewModel.UseSelectedRegionCommand}"
                                           Margin="2" Padding="5,2"/>
                                    <Button Content="Use Selected Point" 
                                           Command="{Binding ScenarioEditorViewModel.UseSelectedPointCommand}"
                                           Margin="2" Padding="5,2"/>
                                    <Separator Margin="5,0"/>
                                    <Button Content="â–¶ Test Step" 
                                           Command="{Binding ScenarioEditorViewModel.TestStepCommand}"
                                           Margin="2" Padding="5,2"
                                           IsEnabled="{Binding ScenarioEditorViewModel.IsTestingStep, Converter={StaticResource InvertedBoolConverter}}"
                                           ToolTip="Test the selected step individually.&#x0a;Requires: Game must be running and process detected.&#x0a;Useful for debugging before running full scenario."/>
                                </StackPanel>
                            </Grid>
                                <Border Background="#F0F8FF"
                                       BorderBrush="#B0C4DE"
                                       BorderThickness="1"
                                       Padding="8,5"
                                       CornerRadius="3"
                                       Margin="5,5,5,5"
                                       Visibility="{Binding ScenarioEditorViewModel.SelectedStep, Converter={StaticResource NullToVisibilityConverter}}">
                                    <StackPanel>
                                        <TextBlock Text="ðŸ’¡ Configure step properties above. Use 'Use Selected Region/Point' buttons to fill coordinates from preview selection." 
                                                  FontSize="11" 
                                                  Foreground="DarkSlateGray" 
                                                  TextWrapping="Wrap"
                                                  FontStyle="Italic"/>
                                        <TextBlock Text="ðŸ’¡ Click 'Test Step' to verify the step works before running the full scenario." 
                                                  FontSize="11" 
                                                  Foreground="DarkSlateGray" 
                                                  TextWrapping="Wrap"
                                                  FontStyle="Italic"
                                                  Margin="0,3,0,0"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </GroupBox>

                        <!-- Template Management -->
                        <Expander Grid.Row="4" 
                                 Header="Template Management" 
                                 IsExpanded="True"
                                 Margin="0,0,0,10">
                            <ScrollViewer VerticalScrollBarVisibility="Auto"
                                         HorizontalScrollBarVisibility="Disabled"
                                         MaxHeight="250">
                                <controls:TemplateManagerControl/>
                            </ScrollViewer>
                        </Expander>

                        <!-- File Management and Validation -->
                        <StackPanel Grid.Row="5" Orientation="Vertical">
                            <!-- File Management Buttons -->
                            <WrapPanel Orientation="Horizontal" Margin="0,0,0,5">
                                <Button Content="New Scenario" 
                                       Command="{Binding ScenarioEditorViewModel.NewScenarioCommand}"
                                       Margin="2" Padding="5,2"
                                       ToolTip="Create new scenario (Ctrl+N)"/>
                                <Button Content="Load Scenario" 
                                       Command="{Binding ScenarioEditorViewModel.LoadScenarioCommand}"
                                       Margin="2" Padding="5,2"
                                       ToolTip="Load scenario from file (Ctrl+O)"/>
                                <Button Content="Save Scenario" 
                                       Command="{Binding ScenarioEditorViewModel.SaveScenarioCommand}"
                                       Margin="2" Padding="5,2"
                                       ToolTip="Save scenario (Ctrl+S)"/>
                                <Button Content="Save As..." 
                                       Command="{Binding ScenarioEditorViewModel.SaveScenarioAsCommand}"
                                       Margin="2" Padding="5,2"
                                       ToolTip="Save scenario with new name (Ctrl+Shift+S)"/>
                                <Separator Margin="5,0" Width="1" Height="20" VerticalAlignment="Center"/>
                                <Button Content="â†¶ Undo" 
                                       Command="{Binding ScenarioEditorViewModel.UndoCommand}"
                                       Margin="2" Padding="5,2"
                                       IsEnabled="{Binding ScenarioEditorViewModel.CanUndo}"
                                       ToolTip="Undo last change (Ctrl+Z)"/>
                                <Button Content="â†· Redo" 
                                       Command="{Binding ScenarioEditorViewModel.RedoCommand}"
                                       Margin="2" Padding="5,2"
                                       IsEnabled="{Binding ScenarioEditorViewModel.CanRedo}"
                                       ToolTip="Redo last undone change (Ctrl+Y)"/>
                            </WrapPanel>

                            <!-- Validation Summary -->
                            <Expander Header="Validation" 
                                     IsExpanded="True"
                                     Margin="0,0,0,5">
                                <StackPanel>
                                    <Border BorderBrush="Orange" BorderThickness="1" 
                                           Background="#FFFFF4E6"
                                           Padding="5"
                                           Margin="0,0,0,5"
                                           Visibility="{Binding ScenarioEditorViewModel.ValidationWarningCount, Converter={StaticResource CountToVisibilityConverter}}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding ScenarioEditorViewModel.ValidationWarningCount, StringFormat='âš ï¸ {0} warning(s)'}"
                                                      FontWeight="SemiBold"
                                                      Foreground="Orange"
                                                      Margin="0,0,0,3"/>
                                        </StackPanel>
                                    </Border>

                                    <Border BorderBrush="Red" BorderThickness="1" 
                                           Background="#FFFFE6E6"
                                           Padding="5"
                                           Margin="0,0,0,5"
                                           Visibility="{Binding ScenarioEditorViewModel.ValidationErrorCount, Converter={StaticResource CountToVisibilityConverter}}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding ScenarioEditorViewModel.ValidationErrorCount, StringFormat='âŒ {0} error(s)'}"
                                                      FontWeight="SemiBold"
                                                      Foreground="Red"
                                                      Margin="0,0,0,3"/>
                            </StackPanel>
                                    </Border>

                                    <!-- Validation Errors List -->
                                    <ScrollViewer VerticalScrollBarVisibility="Auto" 
                                                 MaxHeight="150"
                                         Visibility="{Binding ScenarioEditorViewModel.ValidationErrors.Count, Converter={StaticResource CountToVisibilityConverter}}">
                                        <ItemsControl ItemsSource="{Binding ScenarioEditorViewModel.ValidationErrors}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                                    <Border BorderThickness="0,0,0,1" BorderBrush="#FFCCCCCC" Margin="0,2">
                                        <TextBlock Text="{Binding}" 
                                                                  Foreground="{Binding Converter={StaticResource ValidationErrorColorConverter}}"
                                                  TextWrapping="Wrap" 
                                                                  Margin="5,3"/>
                                                    </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                                    </ScrollViewer>
                                    
                                    <TextBlock Text="ðŸ’¡ Fix validation errors before saving. Click on errors to see details." 
                                              FontSize="11" 
                                              Foreground="Gray" 
                                              TextWrapping="Wrap"
                                              Margin="5,5,5,0"
                                              FontStyle="Italic"
                                              Visibility="{Binding ScenarioEditorViewModel.ValidationErrors.Count, Converter={StaticResource CountToVisibilityConverter}}"/>
                                </StackPanel>
                            </Expander>
                        </StackPanel>
                    </Grid>
                    
                    <!-- Status Bar -->
                    <Border Grid.Row="6" 
                           BorderBrush="LightGray" 
                           BorderThickness="0,1,0,0"
                           Background="#F5F5F5"
                           Padding="10,5"
                           Margin="0,10,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock Text="ðŸ’¡ " 
                                          FontSize="11" 
                                          VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding ScenarioEditorViewModel.StatusHint}" 
                                          FontSize="11" 
                                          Foreground="DarkGray"
                                          VerticalAlignment="Center"
                                          TextWrapping="Wrap"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <TextBlock Text="{Binding ScenarioEditorViewModel.CurrentScenario.Name, StringFormat='Scenario: {0}'}" 
                                          FontSize="11" 
                                          Foreground="DarkBlue"
                                          FontWeight="SemiBold"
                                          Margin="10,0,0,0"
                                          VerticalAlignment="Center"/>
                                <TextBlock Text=" â€¢ " 
                                          FontSize="11" 
                                          Foreground="Gray"
                                          VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding ScenarioEditorViewModel.CurrentScenario.Steps.Count, StringFormat='{0} steps'}" 
                                          FontSize="11" 
                                          Foreground="DarkGray"
                                          VerticalAlignment="Center"/>
                                <TextBlock Text=" â€¢ " 
                                          FontSize="11" 
                                          Foreground="Gray"
                                          VerticalAlignment="Center"
                                          Margin="0,0,10,0"/>
                                <TextBlock Text="{Binding ScenarioEditorViewModel.HasUnsavedChanges, Converter={StaticResource UnsavedChangesTextConverter}}" 
                                          FontSize="11" 
                                          Foreground="{Binding ScenarioEditorViewModel.HasUnsavedChanges, Converter={StaticResource UnsavedChangesColorConverter}}"
                                          FontWeight="SemiBold"
                                          VerticalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                    </Border>
                </Grid>
            </TabItem>
        </TabControl>
    </Grid>
</Window>
